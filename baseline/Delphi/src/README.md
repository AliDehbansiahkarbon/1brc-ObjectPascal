direct port of the Lazarus implementation, with minimal changes only where necessary